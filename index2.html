<!DOCTYPE html>
<html lang="lo">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∫•‡∫≤‡∫ç‡∫à‡ªà‡∫≤‡∫ç (ONLINE)</title>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@100..900&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Noto Sans Lao", sans-serif;
  background:#f5f6fa;
  padding:20px;
}
h2{margin:10px 0}
button{
  cursor:pointer;
  padding:8px 14px;
  border:none;
  border-radius:8px;
  color:#fff;
  font-size:15px;
}
button:hover{opacity:.9}

#goHome{background:#00cec9;margin-bottom:10px}
.addRowBtn{background:#00b894;margin-top:10px}
.clearBtn{background:#d63031;margin-top:10px}
.whatsappBtn{background:#25D366;margin-top:10px}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
}
th,td{
  border:1px solid #dcdde1;
  padding:10px;
  text-align:center;
}
th{
  background:linear-gradient(90deg,#5ce4e7,#07a8ff);
  color:#fff;
}
td[contenteditable="true"]{
  background:#fff;
  outline:none;
}
tfoot td{
  background:#ecf0f1;
  font-weight:bold;
}
.totalAmount{font-weight:900}
#grandTotal{
  font-size:22px;
  font-weight:900;
  margin-top:8px;
}
</style>
</head>

<body>

<button id="goHome">üè† ‡∫Å‡∫±‡∫ö‡ªÑ‡∫õ Home</button>

<h2>‡∫•‡∫≤‡∫ç‡∫à‡ªà‡∫≤‡∫ç (‡∫≠‡∫≠‡∫ô‡∫•‡∫≤‡∫ç ONLINE)</h2>

<table class="expenseTable" data-id="online">
  <thead>
    <tr>
      <th>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô</th>
      <th>‡∫ß‡∫±‡∫ô‡∫ó‡∫µ / ‡ªÄ‡∫ß‡∫•‡∫≤</th>
      <th>‡ªù‡∫≤‡∫ç‡ªÄ‡∫´‡∫î</th>
      <th>‡∫à‡∫≥‡∫ô‡∫ß‡∫ô‡ªÄ‡∫á‡∫¥‡∫ô</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
  <tfoot>
    <tr>
      <td colspan="3">Total</td>
      <td class="totalAmount">0</td>
      <td></td>
    </tr>
  </tfoot>
</table>

<button class="addRowBtn">‚ûï ‡ªÄ‡∫û‡∫µ‡ªà‡∫°‡ªÅ‡∫ñ‡∫ß</button>

<h2>Grand Total</h2>
<div id="grandTotal">0</div>

<button class="whatsappBtn" id="sendWhatsApp">üì§ ‡∫™‡∫ª‡ªà‡∫á WhatsApp</button>
<button class="clearBtn" id="clearAll">üßπ ‡∫•‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô</button>

<script>
/* ---------- helpers ---------- */
function tableKey(table){ return 'expense_' + table.dataset.id; }
function num(txt){
  const n = parseInt(String(txt).replace(/,/g,''),10);
  return isNaN(n)?0:n;
}
function fmt(n){ return Number(n||0).toLocaleString(); }

/* ---------- add row ---------- */
function addRow(tbody,index,data={}){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td>${index}</td>
    <td contenteditable="true" class="date">${data.date||'--/--/---- --:--'}</td>
    <td contenteditable="true" class="remark">${data.remark||''}</td>
    <td contenteditable="true" class="amount">${data.amount||'0'}</td>
    <td><button class="deleteBtn">üóëÔ∏è</button></td>
  `;
  tbody.appendChild(tr);
}

/* ---------- load ---------- */
const table=document.querySelector('.expenseTable');
const tbody=table.querySelector('tbody');
const saved=JSON.parse(localStorage.getItem(tableKey(table)))||[];

if(saved.length){ saved.forEach((r,i)=>addRow(tbody,i+1,r)); }
else{ addRow(tbody,1); }

updateTotal();

/* ---------- add row ---------- */
document.querySelector('.addRowBtn').onclick=()=>{
  addRow(tbody,tbody.children.length+1);
  updateTotal(); saveTable();
};

/* ---------- delete ---------- */
document.body.addEventListener('click',e=>{
  if(e.target.classList.contains('deleteBtn')){
    e.target.closest('tr').remove();
    [...tbody.children].forEach((r,i)=>r.children[0].textContent=i+1);
    updateTotal(); saveTable();
  }
});

/* ---------- INPUT (LOCK CURSOR) ---------- */
document.body.addEventListener('input',e=>{
  if(e.target.classList.contains('amount')){
    const clean = e.target.textContent.replace(/[^\d]/g,'');
    if(e.target.textContent !== clean){ e.target.textContent = clean; }

    const range = document.createRange();
    const sel = window.getSelection();
    range.selectNodeContents(e.target);
    range.collapse(false);
    sel.removeAllRanges();
    sel.addRange(range);

    updateTotal(); saveTable();
  }

  if(e.target.classList.contains('remark')){
    const d=new Date();
    e.target.closest('tr').querySelector('.date').textContent =
      `${String(d.getDate()).padStart(2,'0')}/`+
      `${String(d.getMonth()+1).padStart(2,'0')}/`+
      `${d.getFullYear()} `+
      `${String(d.getHours()).padStart(2,'0')}:`+
      `${String(d.getMinutes()).padStart(2,'0')}`;
    saveTable();
  }
});

/* ---------- blur format ---------- */
document.body.addEventListener('blur',e=>{
  if(e.target.classList.contains('amount')){
    e.target.textContent = fmt(num(e.target.textContent));
    updateTotal(); saveTable();
  }
},true);

/* ---------- totals ---------- */
function updateTotal(){
  let total=0;
  table.querySelectorAll('.amount').forEach(a=> total+=num(a.textContent));
  table.querySelector('.totalAmount').textContent=fmt(total);
  document.getElementById('grandTotal').textContent=fmt(total);
}

/* ---------- save ---------- */
function saveTable(){
  const data=[];
  tbody.querySelectorAll('tr').forEach(tr=>{
    data.push({
      date:tr.querySelector('.date').textContent,
      remark:tr.querySelector('.remark').textContent,
      amount:tr.querySelector('.amount').textContent
    });
  });
  localStorage.setItem(tableKey(table),JSON.stringify(data));
}

/* ---------- clear ---------- */
document.getElementById('clearAll').onclick=()=>{
  if(confirm('‡∫¢‡∫∑‡∫ô‡∫¢‡∫±‡∫ô‡∫•‡ªâ‡∫≤‡∫á‡∫Ç‡ªç‡ªâ‡∫°‡∫π‡∫ô?')){
    localStorage.removeItem(tableKey(table));
    location.reload();
  }
};

/* ---------- WhatsApp ---------- */
document.getElementById('sendWhatsApp').onclick=()=>{
  let msg = 'üìä ‡∫•‡∫≤‡∫ç‡∫à‡ªà‡∫≤‡∫ç (ONLINE)\n\n';
  const now=new Date();
  msg+=`üïí ${now.toLocaleString()}\n\n`;

  tbody.querySelectorAll('tr').forEach(tr=>{
    msg+=`‚Ä¢ ${tr.querySelector('.date').textContent} | `
        +`${tr.querySelector('.remark').textContent} | `
        +`${tr.querySelector('.amount').textContent}\n`;
  });

  msg+=`\nüí∞ Total: ${table.querySelector('.totalAmount').textContent}`;
  msg+=`\nüí∞ Grand Total: ${document.getElementById('grandTotal').textContent}`;

  window.open('https://wa.me/?text='+encodeURIComponent(msg),'_blank');
};

/* ---------- home ---------- */
document.getElementById('goHome').onclick=()=>{
  window.location.href='index.html';
};
</script>
<script>
  (function syncOnlineTotalToExpense(){
    const totalEl = document.querySelector('.totalAmount');
    if(!totalEl) return;
  
    function pushToExpense(){
      const val = totalEl.textContent.replace(/,/g,'').trim();
      if(!val) return;
  
      // ‡∫ö‡∫±‡∫ô‡∫ó‡∫∂‡∫Å‡ªÄ‡∫Ç‡∫ª‡ªâ‡∫≤ localStorage
      localStorage.setItem('expense', val);
    }
  
    // ‡∫à‡∫±‡∫ö‡∫Å‡∫≤‡∫ô‡∫õ‡ªà‡∫Ω‡∫ô‡ªÅ‡∫õ‡∫á Total
    const observer = new MutationObserver(pushToExpense);
    observer.observe(totalEl,{childList:true,subtree:true,characterData:true});
  
    pushToExpense(); // ‡∫Ñ‡∫±‡ªâ‡∫á‡∫ó‡∫≥‡∫≠‡∫¥‡∫î
  })();
  </script>
  
</body>
</html>
